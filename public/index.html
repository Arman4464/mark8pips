<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mark8Pips - License Manager</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #000000;
            color: #ffffff;
        }
        
        /* Login Styles */
        .login-container { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
        }
        .login-box { 
            background: #1a1a1a; 
            padding: 3rem; 
            border-radius: 20px; 
            border: 2px solid #9ACD32;
            width: 400px; 
            text-align: center;
        }
        
        /* Dashboard Layout */
        .dashboard { display: none; }
        .sidebar { 
            position: fixed; 
            left: 0; 
            top: 0; 
            width: 250px; 
            height: 100vh; 
            background: #1a1a1a; 
            border-right: 2px solid #9ACD32;
            transition: all 0.3s;
        }
        .sidebar.collapsed { width: 60px; }
        .sidebar-header { 
            padding: 1rem; 
            border-bottom: 1px solid #333; 
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .toggle-btn {
            background: #9ACD32;
            border: none;
            color: #000000;
            width: 35px;
            height: 35px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .sidebar-menu { list-style: none; padding: 1rem 0; }
        .sidebar-menu a { 
            display: flex; 
            align-items: center; 
            padding: 1rem; 
            color: #ffffff; 
            text-decoration: none; 
            transition: all 0.3s;
        }
        .sidebar-menu a:hover, .sidebar-menu a.active { 
            background: rgba(154, 205, 50, 0.2); 
            color: #9ACD32;
        }
        .sidebar-menu i { width: 20px; margin-right: 15px; }
        .sidebar.collapsed .sidebar-menu span { display: none; }
        
        .main-content { 
            margin-left: 250px; 
            padding: 2rem; 
            transition: all 0.3s;
            min-height: 100vh;
        }
        .main-content.expanded { margin-left: 60px; }
        
        .page-content { display: none; }
        .page-content.active { display: block; }
        
        /* Stats Grid */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 1.5rem; 
            margin-bottom: 2rem; 
        }
        .stat-card { 
            background: #1a1a1a; 
            padding: 2rem; 
            border-radius: 15px; 
            border: 2px solid #9ACD32;
            text-align: center;
        }
        .stat-number { font-size: 2.5rem; font-weight: bold; color: #9ACD32; }
        .stat-label { color: #cccccc; margin-top: 0.5rem; }
        
        /* Cards */
        .card { 
            background: #1a1a1a; 
            border-radius: 15px; 
            border: 2px solid #9ACD32;
            margin-bottom: 2rem;
        }
        .card-header { 
            background: #9ACD32; 
            color: #000000; 
            padding: 1.5rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        .card-body { padding: 2rem; }
        
        /* Tables */
        .table-container { overflow-x: auto; }
        .users-table { width: 100%; border-collapse: collapse; }
        .users-table th, .users-table td { 
            padding: 1rem; 
            text-align: left; 
            border-bottom: 1px solid #333; 
        }
        .users-table th { 
            background: #1a1a1a; 
            color: #9ACD32; 
        }
        .users-table tr:hover { background: rgba(154, 205, 50, 0.1); }
        
        /* Buttons */
        .btn { 
            padding: 0.5rem 1rem; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 0.9rem; 
            margin: 0.25rem;
            transition: all 0.3s;
        }
        .btn-primary { background: #9ACD32; color: #000000; }
        .btn-success { background: #32CD32; color: #000000; }
        .btn-warning { background: #FFA500; color: #000000; }
        .btn-danger { background: #DC143C; color: #ffffff; }
        .btn:hover { transform: translateY(-2px); }
        
        /* Form Controls */
        .form-control { 
            width: 100%; 
            padding: 0.8rem; 
            border: 2px solid #9ACD32; 
            border-radius: 8px; 
            background: #000000;
            color: #ffffff;
            margin-bottom: 1rem;
        }
        
        /* Alerts */
        .alert { 
            padding: 1rem; 
            border-radius: 8px; 
            margin-bottom: 1rem; 
            display: none;
        }
        .alert-success { background: rgba(50, 205, 50, 0.2); color: #32CD32; border: 1px solid #32CD32; }
        .alert-error { background: rgba(220, 20, 60, 0.2); color: #DC143C; border: 1px solid #DC143C; }
        
        /* Status badges */
        .status-badge { 
            padding: 0.3rem 0.8rem; 
            border-radius: 15px; 
            font-size: 0.8rem; 
            font-weight: 600; 
        }
        .status-pending { background: #9ACD32; color: #000000; }
        .status-trial { background: #FFD700; color: #000000; }
        .status-active { background: #32CD32; color: #000000; }
        .status-paused { background: #FFA500; color: #000000; }
        .status-suspended { background: #DC143C; color: #ffffff; }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #cccccc;
        }
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #9ACD32;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h2 style="color: #9ACD32; margin-bottom: 2rem;">Mark8Pips Admin</h2>
            <div id="loginError" class="alert alert-error"></div>
            <form id="loginForm">
                <input type="email" class="form-control" id="loginEmail" placeholder="Email" value="admin@mark8pips.com" required>
                <input type="password" class="form-control" id="loginPassword" placeholder="Password" required>
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 1rem;">
                    <i class="fas fa-sign-in-alt"></i> Sign In
                </button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3 style="color: #9ACD32;">Mark8Pips</h3>
                <button class="toggle-btn" id="toggleBtn" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            <ul class="sidebar-menu">
                <li><a href="#" onclick="showPage('overview')" class="active">
                    <i class="fas fa-chart-bar"></i> <span>Dashboard</span>
                </a></li>
                <li><a href="#" onclick="showPage('users')">
                    <i class="fas fa-users"></i> <span>Users</span>
                </a></li>
                <li><a href="#" onclick="showPage('pending')">
                    <i class="fas fa-clock"></i> <span>Pending</span>
                </a></li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <!-- Overview Page -->
            <div id="overviewPage" class="page-content active">
                <h1 style="margin-bottom: 2rem;">Dashboard Overview</h1>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalUsers">0</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="trialUsers">0</div>
                        <div class="stat-label">Trial Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeUsers">0</div>
                        <div class="stat-label">Active Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="pausedUsers">0</div>
                        <div class="stat-label">Paused Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="pendingUsers">0</div>
                        <div class="stat-label">Pending Approval</div>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="loadDashboardData()">
                    <i class="fas fa-refresh"></i> Refresh Data
                </button>
            </div>

            <!-- Users Page -->
            <div id="usersPage" class="page-content">
                <div class="card">
                    <div class="card-header">
                        <h3>User Management</h3>
                        <button class="btn btn-primary" onclick="loadDashboardData()">
                            <i class="fas fa-refresh"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="users-table">
                                <thead>
                                    <tr>
                                        <th>Account</th>
                                        <th>Name</th>
                                        <th>EA</th>
                                        <th>Status</th>
                                        <th>Type</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pending Page -->
            <div id="pendingPage" class="page-content">
                <div class="card">
                    <div class="card-header">
                        <h3>Pending Approvals</h3>
                        <button class="btn btn-primary" onclick="loadDashboardData()">
                            <i class="fas fa-refresh"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="pendingList">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success/Error Alerts -->
    <div id="alertContainer" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

    <script>
        const API_BASE = window.location.origin;
        let authToken = localStorage.getItem('authToken');
        let currentUsers = [];
        
        if (authToken) {
            showDashboard();
        }
        
        // Simple sidebar toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const toggleBtn = document.getElementById('toggleBtn');
            
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
            
            const icon = toggleBtn.querySelector('i');
            if (sidebar.classList.contains('collapsed')) {
                icon.className = 'fas fa-chevron-right';
            } else {
                icon.className = 'fas fa-bars';
            }
        }
        
        // Login form
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    authToken = result.token;
                    localStorage.setItem('authToken', authToken);
                    showDashboard();
                    loadDashboardData();
                } else {
                    showAlert('Invalid credentials', 'error');
                }
            } catch (error) {
                showAlert('Connection error', 'error');
            }
        });
        
        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            loadDashboardData();
        }
        
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
            });
            
            // Remove active class from all menu items
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId + 'Page').classList.add('active');
            
            // Add active class to clicked menu item
            event.target.closest('a').classList.add('active');
        }
        
        // Load dashboard data
        async function loadDashboardData() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/dashboard`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentUsers = result.users || [];
                    updateStatistics(result.stats);
                    updateUsersTable();
                    updatePendingList();
                    
                    console.log(`ðŸ“Š Loaded ${currentUsers.length} users`);
                } else {
                    showAlert('Failed to load data', 'error');
                }
                
            } catch (error) {
                console.error('Load error:', error);
                showAlert('Network error', 'error');
            }
        }
        
        function updateStatistics(stats) {
            document.getElementById('totalUsers').textContent = stats.total_users || 0;
            document.getElementById('trialUsers').textContent = stats.trial_users || 0;
            document.getElementById('activeUsers').textContent = stats.active_users || 0;
            document.getElementById('pausedUsers').textContent = stats.paused_users || 0;
            document.getElementById('pendingUsers').textContent = stats.pending_approvals || 0;
        }
        
        function updateUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';
            
            const activeUsers = currentUsers.filter(user => user.status !== 'pending');
            
            if (activeUsers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <i class="fas fa-users"></i>
                                <h3>No Active Users</h3>
                                <p>Active users will appear here after approval.</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            activeUsers.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${user.account_number}</strong><br><small>${user.broker_name}</small></td>
                    <td>${user.account_name || 'Unknown'}</td>
                    <td>${user.ea_name || 'Unknown EA'}<br><small>v${user.ea_version || '1.0'}</small></td>
                    <td><span class="status-badge status-${user.status}">${user.status.toUpperCase()}</span></td>
                    <td><span class="status-badge status-${user.subscription_type}">${user.subscription_type.toUpperCase()}</span></td>
                    <td>
                        ${user.status === 'paused' ? 
                            `<button class="btn btn-success" onclick="performAction('resume', ${user.account_number})">
                                <i class="fas fa-play"></i> Resume
                            </button>` : 
                            `<button class="btn btn-warning" onclick="performAction('pause', ${user.account_number})">
                                <i class="fas fa-pause"></i> Pause
                            </button>`
                        }
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function updatePendingList() {
            const container = document.getElementById('pendingList');
            const pendingUsers = currentUsers.filter(user => user.status === 'pending');
            
            if (pendingUsers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-hourglass-half"></i>
                        <h3>No Pending Approvals</h3>
                        <p>New EA activations will appear here for approval.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            pendingUsers.forEach(user => {
                const div = document.createElement('div');
                div.style.cssText = 'background: #2a2a2a; padding: 1.5rem; margin-bottom: 1rem; border-radius: 10px; border: 1px solid #9ACD32;';
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="color: #9ACD32;">${user.account_name} (${user.account_number})</h4>
                            <p style="margin: 0.5rem 0; color: #cccccc;">
                                <strong>Broker:</strong> ${user.broker_name}<br>
                                <strong>EA:</strong> ${user.ea_name} v${user.ea_version}<br>
                                <strong>Balance:</strong> $${user.account_balance} ${user.account_currency}
                            </p>
                            <small style="color: #888;">Requested: ${new Date(user.created_at).toLocaleString()}</small>
                        </div>
                        <div>
                            <button class="btn btn-success" onclick="performAction('approve', ${user.account_number})">
                                <i class="fas fa-check"></i> Approve
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        // Perform actions (approve, pause, resume)
        async function performAction(action, accountNumber) {
            try {
                const response = await fetch(`${API_BASE}/api/admin/dashboard`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, account_number: accountNumber })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message, 'success');
                    loadDashboardData(); // Reload data
                } else {
                    showAlert(result.message || 'Action failed', 'error');
                }
            } catch (error) {
                showAlert('Network error', 'error');
            }
        }
        
        // Show in-page alerts (no external popups)
        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.style.display = 'block';
            alert.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> 
                ${message}
            `;
            
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        // Auto-refresh every 30 seconds
        setInterval(() => {
            if (authToken && document.getElementById('dashboard').style.display !== 'none') {
                loadDashboardData();
            }
        }, 30000);
    </script>
</body>
</html>
